const c=chrome.runtime.getManifest().homepage_url||"http://localhost:3000";async function l(){const e=await fetch(`${c}/api/upload/request`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"}});if(!e.ok){const t=await e.json();throw new Error(t.message||"Failed to request upload URL")}return e.json()}async function u(e,t){if(!(await fetch(e,{method:"PUT",body:t,headers:{"Content-Type":t.type}})).ok)throw new Error("Failed to upload image to blob storage")}async function d(e){return(await fetch(e)).blob()}async function i(e){const{blob_id:t,signed_url:r}=await l();return await u(r,e),t}function s(e){chrome.tabs.create({url:`${c}/editor/new?blob_id=${e}`})}async function p(){return new Promise((e,t)=>{chrome.tabs.captureVisibleTab({format:"png"},async r=>{if(chrome.runtime.lastError){t(new Error(chrome.runtime.lastError.message));return}try{const o=await d(r);e(o)}catch(o){t(o)}})})}async function h(e,t){const r=await createImageBitmap(e),o=new OffscreenCanvas(t.width,t.height),n=o.getContext("2d");if(!n)throw new Error("Failed to get canvas context");return n.drawImage(r,t.x,t.y,t.width,t.height,0,0,t.width,t.height),await o.convertToBlob({type:"image/png"})}async function a(e){let t=await p();if(e)try{t=await h(t,e)}catch(o){console.error("Crop failed, uploading full image",o)}const r=await i(t);s(r)}chrome.runtime.onMessage.addListener((e,t,r)=>{if(e.type==="CAPTURE_AND_UPLOAD")return a().then(()=>{r({success:!0})}).catch(o=>{console.error("Capture and upload failed:",o),r({success:!1,error:o.message})}),!0;if(e.type==="CAPTURE_VISIBLE_TAB")return chrome.tabs.captureVisibleTab({format:"png"},o=>{chrome.runtime.lastError?r({error:chrome.runtime.lastError.message}):r({dataUrl:o})}),!0;if(e.type==="AREA_SELECTED")return a(e.area).then(()=>{r({success:!0})}).catch(o=>{r({success:!1,error:o.message})}),!0});chrome.runtime.onInstalled.addListener(()=>{console.log("Copiedcatz extension installed"),chrome.contextMenus.create({id:"copiedcatz-capture",title:"Copiedcatz: Extract Visual DNA",contexts:["image","page"]})});chrome.contextMenus.onClicked.addListener((e,t)=>{e.menuItemId==="copiedcatz-capture"&&(e.srcUrl?m(e.srcUrl):a())});async function m(e){try{const r=await(await fetch(e)).blob(),o=await i(r);s(o)}catch(t){console.error("Failed to download and upload image:",t)}}

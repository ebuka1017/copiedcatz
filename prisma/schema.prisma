generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================================
// USER MANAGEMENT
// ============================================================================

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  name              String?
  password_hash     String
  email_verified    Boolean   @default(false)
  
  // Subscription
  plan              Plan      @default(FREE)
  credits_remaining Int       @default(10)
  stripe_customer_id String?  @unique
  stripe_subscription_id String? @unique
  subscription_status SubscriptionStatus?
  
  // Timestamps
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt
  last_login_at     DateTime?
  
  // Relations
  templates         Template[]
  uploads           Upload[]
  extractionJobs    ExtractionJob[]
  folders           Folder[]
  workspaces        Workspace[] @relation("WorkspaceOwner")
  workspaceMemberships WorkspaceMember[]

  @@index([email])
  @@index([stripe_customer_id])
}

enum Plan {
  FREE
  STARTER
  PRO
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  TRIALING
}

// ============================================================================
// UPLOADS & EXTRACTION
// ============================================================================

model Upload {
  id          String    @id @default(uuid())
  user_id     String
  user        User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  
  filepath    String    // Vercel Blob path
  status      UploadStatus @default(PENDING)
  
  expires_at  DateTime
  created_at  DateTime  @default(now())
  
  // Relations
  extractionJobs ExtractionJob[]

  @@index([user_id])
  @@index([status])
  @@index([expires_at])
}

enum UploadStatus {
  PENDING
  PROCESSED
  FAILED
  EXPIRED
}

model ExtractionJob {
  id          String    @id @default(uuid())
  user_id     String
  user        User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  
  upload_id   String
  upload      Upload    @relation(fields: [upload_id], references: [id], onDelete: Cascade)
  
  status      ExtractionStatus @default(PROCESSING)
  progress    Int       @default(0)
  error       String?
  
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt

  @@index([user_id])
  @@index([status])
  @@index([created_at])
}

enum ExtractionStatus {
  PROCESSING
  COMPLETED
  FAILED
}

// ============================================================================
// TEMPLATES & VARIATIONS
// ============================================================================

model Template {
  id                  String    @id @default(uuid())
  user_id             String
  user                User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  
  name                String
  original_image_url  String
  structured_prompt   Json      // The extracted Visual DNA
  
  // Organization
  folder_id           String?
  folder              Folder?   @relation(fields: [folder_id], references: [id], onDelete: SetNull)
  is_public           Boolean   @default(false)
  tags                String[]
  
  // Timestamps
  created_at          DateTime  @default(now())
  updated_at          DateTime  @updatedAt
  
  // Relations
  variations          Variation[]

  @@index([user_id])
  @@index([folder_id])
  @@index([created_at])
  @@index([is_public])
  @@index([tags])
}

model Variation {
  id                  String    @id @default(uuid())
  template_id         String
  template            Template  @relation(fields: [template_id], references: [id], onDelete: Cascade)
  
  image_url           String
  seed                Int
  modified_prompt     Json
  generation_time_ms  Int
  
  created_at          DateTime  @default(now())

  @@index([template_id])
  @@index([created_at])
}

// ============================================================================
// ORGANIZATION
// ============================================================================

model Folder {
  id          String    @id @default(uuid())
  user_id     String
  user        User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  
  name        String
  parent_id   String?
  parent      Folder?   @relation("FolderHierarchy", fields: [parent_id], references: [id], onDelete: Cascade)
  children    Folder[]  @relation("FolderHierarchy")
  
  created_at  DateTime  @default(now())
  
  // Relations
  templates   Template[]

  @@index([user_id])
  @@index([parent_id])
}

// ============================================================================
// COLLABORATION
// ============================================================================

model Workspace {
  id          String    @id @default(uuid())
  name        String
  owner_id    String
  owner       User      @relation("WorkspaceOwner", fields: [owner_id], references: [id], onDelete: Cascade)
  
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt
  
  // Relations
  members     WorkspaceMember[]

  @@index([owner_id])
}

model WorkspaceMember {
  id          String    @id @default(uuid())
  workspace_id String
  workspace   Workspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade)
  
  user_id     String
  user        User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  
  role        WorkspaceRole @default(VIEWER)
  joined_at   DateTime  @default(now())

  @@unique([workspace_id, user_id])
}

enum WorkspaceRole {
  ADMIN
  EDITOR
  VIEWER
}

// ============================================================================
// BILLING & USAGE
// ============================================================================

model UsageLog {
  id          String    @id @default(uuid())
  user_id     String
  
  action      UsageAction
  credits_used Int      @default(1)
  metadata    Json?
  
  created_at  DateTime  @default(now())

  @@index([user_id])
  @@index([created_at])
}

enum UsageAction {
  EXTRACTION
  GENERATION
  API_CALL
}

model StripeEvent {
  id              String    @id @default(uuid())
  stripe_event_id String    @unique
  type            String
  data            Json
  processed       Boolean   @default(false)
  
  created_at      DateTime  @default(now())

  @@index([processed])
  @@index([created_at])
}
